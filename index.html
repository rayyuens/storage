<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Whatsup PRO">
<meta name="theme-color" content="#3b82f6">

<title>Whatsup PRO</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/5.4.2/photoswipe.min.css">
<script type="module">
import PhotoSwipeLightbox from 'https://cdnjs.cloudflare.com/ajax/libs/photoswipe/5.4.2/photoswipe-lightbox.esm.min.js';
const lightbox = new PhotoSwipeLightbox({
gallery: '#feed',
children: 'a.pswp-link',
pswpModule: () => import('https://cdnjs.cloudflare.com/ajax/libs/photoswipe/5.4.2/photoswipe.esm.min.js')
});
lightbox.init();
window.psLightbox = lightbox;
</script>

<style>
:root {
--primary: #3b82f6; 
--primary-hover: #2563eb;
--bg: #f3f4f6;
--header-bg: rgba(255, 255, 255, 0.85);
--card-bg: #ffffff;
--text-main: #111827;
--text-sub: #6b7280;
--border: #e5e7eb;
--input-bg: #ffffff;
--input-border: #e5e7eb;
--code-bg: #111827;
--shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
--shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
--shadow-float: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
--radius-lg: 16px;
--radius-xl: 24px;
--ai-purple: #8b5cf6;
}

[data-theme="dark"] {
--bg: #000000;
--header-bg: rgba(18, 18, 18, 0.85);
--card-bg: #121212;
--text-main: #f3f4f6;
--text-sub: #9ca3af;
--border: #27272a;
--input-bg: #18181b;
--input-border: #3f3f46;
--code-bg: #000000;
--shadow-sm: none;
--shadow-md: none;
--shadow-float: 0 0 0 1px #27272a;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease; }

body {
font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
height: 100dvh;
margin: 0;
display: flex;
flex-direction: column;
background-color: var(--bg);
color: var(--text-main);
overflow: hidden;
}

.header-section { 
padding: 12px 20px;
padding-top: calc(env(safe-area-inset-top) + 12px);
display: flex; align-items: center; justify-content: space-between;
background: var(--header-bg); 
backdrop-filter: blur(12px);
-webkit-backdrop-filter: blur(12px);
z-index: 10; 
border-bottom: 1px solid var(--border);
position: sticky; top: 0;
}
.header-section h1 { 
font-size: 20px; font-weight: 700; margin: 0; 
background: linear-gradient(135deg, var(--text-main) 0%, var(--text-sub) 100%);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
cursor: pointer;
letter-spacing: -0.5px;
}
.theme-toggle { 
font-size: 20px; cursor: pointer; padding: 8px; 
border-radius: 50%; background: transparent;
transition: background 0.2s;
}
.theme-toggle:hover { background: rgba(128,128,128,0.1); }

.feed-container { flex: 1; overflow-y: auto; padding: 20px; scroll-behavior: smooth; }

.item-row { 
background: var(--card-bg); border-radius: var(--radius-lg); padding: 20px; 
margin-bottom: 24px; max-width: 768px; margin-left: auto; margin-right: auto;
box-shadow: var(--shadow-sm);
border: 1px solid var(--border);
position: relative;
}

.item-header {
display: flex; justify-content: space-between; align-items: center;
font-size: 12px; color: var(--text-sub); margin-bottom: 12px;
font-weight: 500;
}
.item-time { display: flex; align-items: center; gap: 6px; }
.item-time::before { content:''; width: 6px; height: 6px; background: var(--border); border-radius: 50%; }

.action-row { display: flex; gap: 6px; align-items: center; }
.action-btn { 
cursor: pointer; font-size: 11px; padding: 4px 10px; border-radius: 20px; 
font-weight: 600; transition: all 0.2s; 
}
.ai-btn { background: rgba(139, 92, 246, 0.1); color: var(--ai-purple); border: 1px solid rgba(139, 92, 246, 0.2); }
.ai-btn:hover { background: var(--ai-purple); color: white; }
.copy-btn { background: rgba(59, 130, 246, 0.1); color: var(--primary); }
.copy-btn:hover { background: var(--primary); color: white; }
.del-btn { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
.del-btn:hover { background: #ef4444; color: white; }

.content-wrapper {
position: relative;
font-size: 15px; line-height: 1.6;
max-height: 300px; 
overflow: hidden;
transition: max-height 0.4s cubic-bezier(0, 0, 0.2, 1);
}
.content-wrapper a { color: var(--primary); text-decoration: none; font-weight: 500; }
.content-wrapper a:hover { text-decoration: underline; }

.content-wrapper.expanded { max-height: none; }
.content-wrapper.has-overflow:not(.expanded)::after {
content: "";
position: absolute; bottom: 0; left: 0; right: 0; height: 80px;
background: linear-gradient(transparent, var(--card-bg));
pointer-events: none;
}

pre[class*="language-"] {
margin: 12px 0 !important;
border-radius: 12px !important;
font-size: 13px !important;
border: 1px solid var(--border) !important;
background: var(--code-bg) !important;
box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
}

/* Link Preview Styles */
.link-preview {
margin-top: 12px;
border: 1px solid var(--border);
border-radius: 12px;
overflow: hidden;
background: var(--bg);
display: flex;
flex-direction: column;
text-decoration: none !important;
transition: transform 0.2s;
}
.link-preview:hover { transform: translateY(-2px); border-color: var(--primary); }
.lp-content { padding: 12px; display: flex; align-items: center; gap: 12px; }
.lp-icon { font-size: 24px; flex-shrink: 0; }
.lp-info { overflow: hidden; }
.lp-title { font-weight: 600; font-size: 14px; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.lp-url { font-size: 12px; color: var(--text-sub); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

.expand-hint {
text-align: center; color: var(--text-sub); font-size: 12px;
font-weight: 500; margin-top: 12px; display: none; cursor: pointer; padding: 6px 0;
background: rgba(0,0,0,0.03); border-radius: 8px;
transition: background 0.2s;
}
.expand-hint:hover { background: rgba(0,0,0,0.06); color: var(--text-main); }

.attachment-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
gap: 12px; margin-top: 16px;
}
.post-img-container {
position: relative; border-radius: 12px; overflow: hidden;
aspect-ratio: 1; border: 1px solid var(--border);
transition: transform 0.2s;
}
.post-img-container:hover { transform: scale(1.02); }
.post-img { width: 100%; height: 100%; object-fit: cover; cursor: zoom-in; }

.file-attachment {
display: flex; align-items: center; gap: 12px;
padding: 12px 16px; background: var(--bg); border-radius: 12px; 
font-size: 13px; border: 1px solid var(--border); margin-top: 10px; 
color: var(--text-main); transition: 0.2s;
text-decoration: none;
}
.file-attachment:hover { border-color: var(--primary); transform: translateY(-1px); }
.file-icon { font-size: 20px; }
.dl-btn-round { 
cursor: pointer; width: 32px; height: 32px; 
display: flex; align-items: center; justify-content: center;
background: rgba(255,255,255,0.9); border-radius: 50%; 
position: absolute; bottom: 8px; right: 8px;
box-shadow: 0 2px 5px rgba(0,0,0,0.15);
color: #333; transition: 0.2s;
border: none;
}
.dl-btn-round:hover { transform: scale(1.1); }

.wa-footer {
padding: 12px 20px;
padding-bottom: calc(env(safe-area-inset-bottom) + 12px);
background: transparent;
pointer-events: none;
z-index: 100;
}

.input-wrapper {
pointer-events: auto;
background: var(--input-bg); border-radius: var(--radius-xl); 
padding: 8px;
max-width: 768px; margin: 0 auto;
box-shadow: var(--shadow-float);
border: 1px solid var(--input-border);
transition: border-color 0.2s, transform 0.2s;
}

.input-wrapper.drag-over {
border-color: var(--primary);
transform: scale(1.02);
box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
}

.wa-input-row { display: flex; align-items: flex-end; gap: 10px; padding: 4px; }

textarea {
flex: 1; border: none; outline: none; font-size: 16px;
padding: 12px 4px; max-height: 140px; resize: none;
background: transparent; line-height: 1.5; color: var(--text-main);
min-height: 44px;
font-family: inherit;
}
textarea::placeholder { color: var(--text-sub); opacity: 0.7; }

.icon-btn { 
background: transparent; border: none; width: 44px; height: 44px;
border-radius: 50%; display: flex; align-items: center; justify-content: center;
cursor: pointer; font-size: 24px; color: var(--text-sub);
transition: 0.2s;
}
.icon-btn:hover { background: var(--bg); color: var(--primary); }

.send-btn { 
background: var(--primary); color: white; 
width: 44px; height: 44px; border-radius: 14px;
margin-left: 4px;
}
.send-btn:hover { background: var(--primary-hover); color: white; transform: scale(1.05); }
.send-btn:disabled { background: var(--text-sub); opacity: 0.5; transform: none; }

#progressBox {
display: none; height: 3px; background: var(--bg); 
border-radius: 2px; margin: 0 16px 8px; overflow: hidden;
}
#progressBar {
width: 0%; height: 100%; background: var(--primary);
border-radius: 2px;
transition: width 0.3s ease;
}

#previewContainer { 
display: none; padding: 12px 16px 4px; gap: 10px; 
overflow-x: auto; white-space: nowrap; 
border-bottom: 1px solid var(--border);
margin-bottom: 4px;
}
#previewContainer::-webkit-scrollbar { display: none; }

.preview-item { position: relative; display: inline-block; width: 64px; height: 64px; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
.preview-item img { width: 100%; height: 100%; object-fit: cover; }
.remove-preview {
position: absolute; top: 2px; right: 2px; background: rgba(0,0,0,0.6);
color: white; border: none; border-radius: 50%; width: 20px; height: 20px;
font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;
backdrop-filter: blur(2px);
}

#qualitySelector { display: none; font-size: 11px; gap: 8px; padding: 0 16px 12px; align-items: center; }
.q-chip { 
cursor: pointer; color: var(--text-sub); padding: 4px 12px; border-radius: 20px; 
background: var(--bg); transition: 0.2s; border: 1px solid transparent;
font-weight: 500;
}
.q-chip:hover { border-color: var(--border); }
.q-chip.active { background: rgba(59, 130, 246, 0.1); color: var(--primary); border-color: rgba(59, 130, 246, 0.2); }

.toast {
position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%) scale(0.9);
background: rgba(17, 24, 39, 0.9); backdrop-filter: blur(4px);
color: white; padding: 10px 24px; border-radius: 30px;
font-size: 14px; font-weight: 500; z-index: 10000; display: none;
box-shadow: 0 4px 12px rgba(0,0,0,0.2);
animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}
@keyframes popUp { to { transform: translateX(-50%) scale(1); } }

.update-banner {
position: fixed; top: 0; left: 0; right: 0;
background: var(--primary); color: white;
padding: 12px; text-align: center; font-size: 14px;
z-index: 10000; display: none; cursor: pointer;
box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
animation: slideDown 0.4s ease;
font-weight: 600;
}
@keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }

.spinner { animation: rotate 2s linear infinite; width: 20px; height: 20px; }
.spinner .path { stroke: white; stroke-linecap: round; animation: dash 1.5s ease-in-out infinite; }
@keyframes rotate { 100% { transform: rotate(360deg); } }
@keyframes dash {
0% { stroke-dasharray: 1, 150; stroke-dashoffset: 0; }
50% { stroke-dasharray: 90, 150; stroke-dashoffset: -35; }
100% { stroke-dasharray: 90, 150; stroke-dashoffset: -124; }
}
</style>
</head>
<body>

<div id="updateBanner" class="update-banner" onclick="applyUpdate()">
ðŸš€ New version available! Click here to update.
</div>

<div id="toast" class="toast">Copied to clipboard</div>

<div class="header-section">
<div style="display: flex; align-items: center; gap: 12px;">
<h1 onclick="toggleTheme()">Whatsup</h1>
<div style="font-size: 11px; background:linear-gradient(135deg, #3b82f6, #8b5cf6); color: white; font-weight: 700; padding: 2px 6px; border-radius: 6px;">PRO</div>
</div>
<div class="theme-toggle" onclick="toggleTheme()" id="themeIcon">
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
</div>
</div>

<div class="feed-container" id="feed"></div>

<div class="wa-footer">
<div class="input-wrapper" id="dropZone">
<div id="previewContainer"></div>
<div id="progressBox"><div id="progressBar"></div></div>

<div class="wa-input-row">
<label for="photo" class="icon-btn">
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
</label>
<input type="file" id="photo" style="display:none" multiple>
<textarea id="msg" rows="1" placeholder="Type a message, code, or drop files..." oninput="autoResize(this)"></textarea>
<button id="uploadBtn" class="send-btn">
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="margin-top:2px; margin-left:-2px"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
</button>
</div>
<div id="qualitySelector">
<span style="color:var(--text-sub); margin-right:4px;">Image Mode:</span>
<span id="modeCompress" class="q-chip active" onclick="setMode('compress')">Smart Compress</span>
<span id="modeRaw" class="q-chip" onclick="setMode('raw')">Original</span>
</div>
</div>
</div>

<script>
// --- PWA Service Worker Registration ---
// å–º index.html å˜… PWA registration å…¥é¢åŠ ï¼š
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').then(reg => {
    // æª¢æŸ¥æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬
    reg.onupdatefound = () => {
      const installingWorker = reg.installing;
      installingWorker.onstatechange = () => {
        if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
          // é¡¯ç¤ºä½ å€‹ updateBanner
          document.getElementById('updateBanner').style.display = 'block';
        }
      };
    };
  });
}

const APP_VERSION = '4.3'; 
const SB_URL = 'https://tywvhvarouhzapqihcit.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR5d3ZodmFyb3VoemFwcWloY2l0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5ODI2OTMsImV4cCI6MjA4MjU1ODY5M30.3LLxsdfXHZ3EkpNpwI5AzKHCSx1499Ha7tXzS6mkTvI';
const db = supabase.createClient(SB_URL, SB_KEY);

function initTheme() {
const savedTheme = localStorage.getItem('theme');
if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
document.documentElement.setAttribute('data-theme', 'dark');
updateThemeIcon('dark');
} else {
updateThemeIcon('light');
}
}
function toggleTheme() {
const target = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
document.documentElement.setAttribute('data-theme', target);
localStorage.setItem('theme', target);
updateThemeIcon(target);
}
function updateThemeIcon(theme) {
const icon = document.getElementById('themeIcon');
if (theme === 'dark') {
icon.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>';
} else {
icon.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>';
}
}
initTheme();

let uploadMode = 'compress';
let selectedFiles = [];

const msgInput = document.getElementById('msg');
const photoInput = document.getElementById('photo');
const feed = document.getElementById('feed');
const uploadBtn = document.getElementById('uploadBtn');
const previewContainer = document.getElementById('previewContainer');
const dropZone = document.getElementById('dropZone');
const progressBox = document.getElementById('progressBox');
const progressBar = document.getElementById('progressBar');

const SPINNER_HTML = `<svg class="spinner" viewBox="0 0 50 50"><circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle></svg>`;
const SEND_ICON_HTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="margin-top:2px; margin-left:-2px"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>`;

function autoResize(textarea) {
textarea.style.height = 'auto';
textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
}

// URL Detect and Linkify logic
function linkify(text) {
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    return text.replace(urlRegex, function(url) {
        return `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`;
    });
}

function generateLinkPreview(text) {
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    const match = text.match(urlRegex);
    if (match && match.length > 0) {
        const url = match[0];
        const domain = new URL(url).hostname;
        return `
            <a href="${url}" target="_blank" class="link-preview">
                <div class="lp-content">
                    <span class="lp-icon">ðŸ”—</span>
                    <div class="lp-info">
                        <div class="lp-title">Visit Link</div>
                        <div class="lp-url">${domain}</div>
                    </div>
                </div>
            </a>
        `;
    }
    return '';
}

dropZone.addEventListener('dragover', (e) => { 
    e.preventDefault(); 
    dropZone.classList.add('drag-over'); 
});
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('drag-over');
    const files = Array.from(e.dataTransfer.files);
    if (files.length > 0) { 
        selectedFiles = [...selectedFiles, ...files]; 
        renderPreviews(); 
    }
});

msgInput.addEventListener('paste', (e) => {
    const items = (e.clipboardData || e.originalEvent.clipboardData).items;
    let foundImage = false;
    for (let index in items) {
        const item = items[index];
        if (item.kind === 'file' && item.type.startsWith('image/')) {
            const blob = item.getAsFile();
            const file = new File([blob], `pasted_image_${Date.now()}.png`, { type: blob.type });
            selectedFiles.push(file);
            foundImage = true;
        }
    }
    if (foundImage) {
        renderPreviews();
    }
});

msgInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) { 
        e.preventDefault(); 
        handleSend(); 
    }
});

function escapeHTML(str) {
return str ? str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m])) : '';
}

function getFileNameFromUrl(url) {
try {
const decodedUrl = decodeURIComponent(url);
const fullFileName = decodedUrl.split('/').pop();
return fullFileName.includes('_') ? fullFileName.split('_').slice(1).join('_') : fullFileName;
} catch(e) { return "Unknown File"; }
}

async function downloadFile(url, filename) {
try {
const res = await fetch(url);
const blob = await res.blob();
const a = document.createElement('a');
a.href = URL.createObjectURL(blob);
a.download = filename || getFileNameFromUrl(url);
document.body.appendChild(a);
a.click();
document.body.removeChild(a);
URL.revokeObjectURL(a.href);
} catch (e) {
window.open(url, '_blank');
}
}

async function explainMsg(id) {
    const wrapper = document.getElementById(`wrapper-${id}`);
    const btn = event.currentTarget;
    const originalText = btn.innerText;
    if (!wrapper) return;
    const textContent = wrapper.innerText;
    const row = wrapper.closest('.item-row');
    const imgElements = row.querySelectorAll('.post-img');
    const images = Array.from(imgElements).map(img => img.src);

    btn.innerText = "åˆ†æžä¸­...";
    btn.style.opacity = "0.5";
    btn.style.pointerEvents = "none";

    try {
        const response = await fetch(`${SB_URL}/functions/v1/explain-ai`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${SB_KEY}`,
                'apikey': SB_KEY
            },
            body: JSON.stringify({ text: textContent, images: images })
        });
        const data = await response.json();
        if (data.explanation) {
            const aiFormattedMessage = `ðŸ¤– AI Explain (å›žæ‡‰è¨Šæ¯ #${id}):\n\n${data.explanation}`;
            await db.from('posts').insert([{ message: aiFormattedMessage, url: JSON.stringify([]) }]);
            showToast("AI è§£é‡‹å·²ç™¼ä½ˆï¼");
        }
    } catch (e) {
        showToast("âš ï¸ AI å‡ºéŒ¯");
    } finally {
        btn.innerText = originalText;
        btn.style.opacity = "1";
        btn.style.pointerEvents = "auto";
    }
}

function render(data) {
if (!data) return;
feed.innerHTML = data.map(p => {
const time = new Date(p.created_at).toLocaleString([], {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'});
const isCode = p.message && (p.message.includes('=>') || p.message.includes('{') || p.message.includes('const ') || p.message.includes('import ') || p.message.includes('<div'));
const safeBase64 = window.btoa(unescape(encodeURIComponent(p.message || "")));

let urls = [];
if (p.url) { try { urls = JSON.parse(p.url); } catch(e) { urls = p.url.split(','); } }
if (!Array.isArray(urls)) urls = [urls];

const imgs = urls.filter(u => u.match(/\.(jpg|jpeg|png|gif|webp)/i));
const files = urls.filter(u => !u.match(/\.(jpg|jpeg|png|gif|webp)/i));

let attachmentHTML = '';
if (imgs.length > 0) {
attachmentHTML += `<div class="attachment-grid">${imgs.map(u => `
                   <div class="post-img-container">
                       <a href="${u}" class="pswp-link" data-pswp-width="1200" data-pswp-height="1200" target="_blank">
                           <img src="${u}" class="post-img" loading="lazy">
                       </a>
                       <button class="dl-btn-round" onclick="downloadFile('${u}')">
                           <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                       </button>
                   </div>
               `).join('')}</div>`;
}
if (files.length > 0) {
attachmentHTML += files.map(u => {
const fname = getFileNameFromUrl(u);
return `
                   <div class="file-attachment">
                       <span class="file-icon">ðŸ“„</span>
                       <div style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; cursor:pointer" onclick="window.open('${u}')">
                           <div style="font-weight:500;">${escapeHTML(fname)}</div>
                       </div>
                       <span onclick="downloadFile('${u}', '${fname}')" style="cursor:pointer; padding:5px;">
                           <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                       </span>
                   </div>
               `}).join('');
}

const linkPreviewHTML = p.message ? generateLinkPreview(p.message) : '';

return `
               <div class="item-row">
                   <div class="item-header">
                       <div class="item-time">${time}</div>
                       <div class="action-row">
                           <span class="action-btn ai-btn" onclick="explainMsg(${p.id})">AI Explain</span>
                           <span class="action-btn copy-btn" onclick="copySafe('${safeBase64}')">Copy</span>
                           <span class="action-btn del-btn" onclick="deletePost(${p.id})">Delete</span>
                       </div>
                   </div>
                   <div class="content-wrapper" id="wrapper-${p.id}">
                       ${isCode ? `<pre class="language-javascript"><code>${escapeHTML(p.message)}</code></pre>` : `<div style="white-space:pre-wrap;">${linkify(escapeHTML(p.message))}</div>`}
                       ${linkPreviewHTML}
                   </div>
                   <div class="expand-hint" id="hint-${p.id}" onclick="toggleExpandById(${p.id})">Show more</div>
                   ${attachmentHTML}
               </div>
           `;
}).join('');

Prism.highlightAll(); 
checkOverflow();
feed.scrollTop = feed.scrollHeight;
}

async function handleSend() {
const message = msgInput.value.trim();
if (selectedFiles.length === 0 && !message) return;
uploadBtn.disabled = true;
uploadBtn.innerHTML = SPINNER_HTML;
if (selectedFiles.length > 0) progressBox.style.display = 'block';
try {
let uploadedUrls = [];
for (let i = 0; i < selectedFiles.length; i++) {
const file = selectedFiles[i];
const finalFile = (file.type.startsWith('image/') && uploadMode === 'compress') ? await compressImage(file) : file;
const path = `${Date.now()}_${file.name}`;
progressBar.style.width = '0%';
await db.storage.from('uploads').upload(path, finalFile);
uploadedUrls.push(db.storage.from('uploads').getPublicUrl(path).data.publicUrl);
}
await db.from('posts').insert([{ message, url: JSON.stringify(uploadedUrls) }]);
msgInput.value = ''; msgInput.style.height = 'auto';
clearPhoto();
fetchPosts();
} catch (e) { alert('Failed: ' + e.message); } finally {
uploadBtn.disabled = false;
uploadBtn.innerHTML = SEND_ICON_HTML;
progressBox.style.display = 'none';
}
}

uploadBtn.onclick = handleSend;

photoInput.onchange = () => {
const files = Array.from(photoInput.files);
if (files.length > 0) { selectedFiles = [...selectedFiles, ...files]; renderPreviews(); }
photoInput.value = '';
};

function renderPreviews() {
previewContainer.innerHTML = '';
if (selectedFiles.length === 0) {
previewContainer.style.display = 'none';
document.getElementById('qualitySelector').style.display = 'none';
return;
}
previewContainer.style.display = 'flex';
document.getElementById('qualitySelector').style.display = 'flex';
selectedFiles.forEach((file, index) => {
const div = document.createElement('div');
div.className = 'preview-item';
div.innerHTML = `<button class="remove-preview" onclick="removeFile(${index})">âœ•</button>`;
const img = document.createElement('img');
if (file.type.startsWith('image/')) {
const reader = new FileReader();
reader.onload = (e) => img.src = e.target.result;
reader.readAsDataURL(file);
} else { img.src = 'https://cdn-icons-png.flaticon.com/512/2991/2991108.png'; }
div.appendChild(img);
previewContainer.appendChild(div);
});
}

function removeFile(index) { selectedFiles.splice(index, 1); renderPreviews(); }
function clearPhoto() { selectedFiles = []; renderPreviews(); }
function setMode(mode) {
uploadMode = mode;
document.getElementById('modeCompress').classList.toggle('active', mode === 'compress');
document.getElementById('modeRaw').classList.toggle('active', mode === 'raw');
}
async function compressImage(file) {
return new Promise((resolve) => {
const img = new Image();
img.src = URL.createObjectURL(file);
img.onload = () => {
const canvas = document.createElement('canvas');
const MAX = 1200;
let w = img.width, h = img.height;
if (w > MAX) { h *= MAX/w; w = MAX; }
canvas.width = w; canvas.height = h;
canvas.getContext('2d').drawImage(img, 0, 0, w, h);
canvas.toBlob(b => resolve(b), 'image/jpeg', 0.8);
};
});
}
function showToast(text = "Copied to clipboard") {
const t = document.getElementById('toast');
t.innerText = text; t.style.display = 'block';
setTimeout(() => t.style.display = 'none', 1500);
}
function copySafe(base64Str) {
const text = decodeURIComponent(escape(window.atob(base64Str)));
navigator.clipboard.writeText(text).then(() => showToast());
}
function checkOverflow() {
document.querySelectorAll('.content-wrapper').forEach(wrapper => {
const hint = wrapper.parentElement.querySelector('.expand-hint');
if (wrapper.scrollHeight > 300) {
wrapper.classList.add('has-overflow');
if (hint) hint.style.display = 'block';
} else {
wrapper.style.maxHeight = 'none';
wrapper.classList.remove('has-overflow');
if (hint) hint.style.display = 'none';
}
});
}
function toggleExpandById(id) {
const w = document.getElementById(`wrapper-${id}`), h = document.getElementById(`hint-${id}`);
w.classList.toggle('expanded');
h.innerText = w.classList.contains('expanded') ? "Collapse" : "Show more";
}
async function fetchPosts() {
const { data } = await db.from('posts').select('*').order('created_at', { ascending: true });
render(data);
}
async function deletePost(id) { 
await db.from('posts').delete().eq('id', id); 
fetchPosts(); 
}
function applyUpdate() { location.reload(true); }

db.channel('posts').on('postgres_changes', { event: '*', schema: 'public', table: 'posts' }, fetchPosts).subscribe();
fetchPosts();
</script>

</body>
</html>
