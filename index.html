<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Whatsup PRO">
    
    <title>Whatsup PRO</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
<style>
    :root {
        --primary: #1a73e8;
        --bg: #ffffff;
        --card-bg: #f8f9fa;
        --text-main: #1f1f1f;
        --text-sub: #70757a;
        --border: #dee2e6;
        --input-bg: #f0f4f9;
        --code-bg: #1e1e1e;
        --code-text: #d4d4d4;
        --header-bg: #ffffff;
    }

    [data-theme="dark"] {
        --bg: #121212;
        --card-bg: #1e1e1e;
        --text-main: #e8eaed;
        --text-sub: #9aa0a6;
        --border: #3c4043;
        --input-bg: #2a2b2e;
        --code-bg: #000000;
        --code-text: #e0e0e0;
        --header-bg: #121212;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; transition: background-color 0.3s, color 0.3s; }

    body {
        font-family: 'Inter', -apple-system, sans-serif;
        height: 100dvh;
        margin: 0;
        display: flex;
        flex-direction: column;
        background-color: var(--bg);
        color: var(--text-main);
        overflow: hidden;
    }

    .update-banner {
        position: fixed; top: 0; left: 0; right: 0;
        background: var(--primary); color: white;
        padding: 12px; text-align: center; font-size: 14px;
        z-index: 10000; display: none; cursor: pointer;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        animation: slideDown 0.4s ease;
        font-weight: 600;
    }
    @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }

    .header-section { 
        padding: 16px 20px;
        padding-top: calc(env(safe-area-inset-top) + 10px);
        display: flex; align-items: center; justify-content: space-between;
        background: var(--header-bg); z-index: 10; border-bottom: 1px solid var(--border);
    }
    .header-section h1 { font-size: 18px; font-weight: 500; margin: 0; color: var(--text-main); cursor: pointer; }

    .theme-toggle { font-size: 20px; cursor: pointer; padding: 5px; }

    .feed-container { flex: 1; overflow-y: auto; padding: 20px; scroll-behavior: smooth; }

    .item-row { 
        background: var(--card-bg); border-radius: 20px; padding: 16px; 
        margin-bottom: 20px; max-width: 800px; margin-left: auto; margin-right: auto;
        box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        position: relative;
    }

    .item-header {
        display: flex; justify-content: space-between;
        font-size: 11px; color: var(--text-sub); margin-bottom: 8px;
        text-transform: uppercase; letter-spacing: 0.5px;
    }

    .action-row { display: flex; gap: 15px; align-items: center; }
    .copy-btn { cursor: pointer; color: var(--primary); font-weight: 600; }
    .del-btn { color: #ea4335; cursor: pointer; font-weight: 600; }

    .content-wrapper {
        position: relative;
        max-height: 200px; 
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }
    .content-wrapper.expanded { max-height: none; }
    .content-wrapper.has-overflow:not(.expanded)::after {
        content: "";
        position: absolute;
        bottom: 0; left: 0; right: 0;
        height: 50px;
        background: linear-gradient(transparent, var(--card-bg));
        pointer-events: none;
    }

    .code-block {
        background: var(--code-bg); color: var(--code-text); padding: 14px; 
        border-radius: 12px; font-family: 'Courier New', monospace; 
        font-size: 13px; overflow-x: auto; margin: 10px 0;
        white-space: pre; border: 1px solid var(--border); line-height: 1.5;
    }

    .expand-hint {
        text-align: center; color: var(--primary); font-size: 12px;
        font-weight: 600; margin-top: 8px; display: none; cursor: pointer; padding: 4px 0;
    }

    .attachment-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 8px;
        margin-top: 12px;
    }
    .post-img { 
        width: 100%; aspect-ratio: 1/1; object-fit: cover;
        border-radius: 12px; cursor: pointer; border: 1px solid var(--border);
    }
    .file-attachment {
        display: flex; align-items: center; gap: 10px;
        padding: 12px; background: var(--input-bg); border-radius: 12px; 
        font-size: 13px; border: 1px solid var(--border); margin-top: 8px; 
        color: var(--text-main); 
        word-break: break-all;
    }
    .file-attachment:hover { filter: brightness(0.95); }
    .dl-icon { 
        cursor: pointer; font-size: 18px; padding: 4px;
        border-radius: 50%; transition: background 0.2s;
    }
    .dl-icon:hover { background: rgba(0,0,0,0.1); }

    .wa-footer {
        padding: 15px 20px;
        padding-bottom: calc(env(safe-area-inset-bottom) + 15px);
        background: var(--bg);
        border-top: 1px solid var(--border);
    }

    .input-wrapper {
        background: var(--input-bg); border-radius: 28px; padding: 8px 12px;
        max-width: 800px; margin: 0 auto;
        border: 2px dashed transparent;
        position: relative;
    }

    .input-wrapper.drag-over {
        border-color: var(--primary);
        background-color: rgba(26, 115, 232, 0.1);
    }

    .wa-input-row { display: flex; align-items: flex-end; gap: 8px; }
    
    textarea {
        flex: 1; border: none; outline: none; font-size: 16px;
        padding: 10px; max-height: 150px; resize: none;
        background: transparent; line-height: 1.4; color: var(--text-main);
    }

    .icon-btn { 
        background: transparent; border: none; width: 40px; height: 40px;
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        cursor: pointer; font-size: 24px; color: var(--text-sub);
    }

    .send-btn { background: var(--primary); color: white; transition: 0.2s; font-size: 18px; position: relative; }

    #progressBox {
        display: none; height: 4px; background: #eee; border-radius: 2px;
        margin: 8px 12px; overflow: hidden;
    }
    #progressBar {
        width: 0%; height: 100%; background: var(--primary);
        transition: width 0.3s ease;
    }

    .spinner { animation: rotate 2s linear infinite; width: 24px; height: 24px; }
    .spinner .path { stroke: white; stroke-linecap: round; animation: dash 1.5s ease-in-out infinite; }
    @keyframes rotate { 100% { transform: rotate(360deg); } }
    @keyframes dash {
        0% { stroke-dasharray: 1, 150; stroke-dashoffset: 0; }
        50% { stroke-dasharray: 90, 150; stroke-dashoffset: -35; }
        100% { stroke-dasharray: 90, 150; stroke-dashoffset: -124; }
    }

    #previewContainer { display: none; padding: 10px; gap: 8px; overflow-x: auto; white-space: nowrap; }
    .preview-item { position: relative; display: inline-block; width: 60px; height: 60px; }
    .preview-item img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
    .remove-preview {
        position: absolute; top: -5px; right: -5px; background: #444746;
        color: white; border: none; border-radius: 50%; width: 18px; height: 18px;
        font-size: 10px; cursor: pointer;
    }

    #qualitySelector { display: none; font-size: 11px; gap: 12px; padding: 5px 12px 10px; }
    .q-chip { cursor: pointer; color: var(--text-sub); padding: 2px 8px; border-radius: 10px; }
    .q-chip.active { background: var(--bg); color: var(--primary); font-weight: 600; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    
    .toast {
        position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
        background: #323232; color: white; padding: 8px 20px; border-radius: 20px;
        font-size: 13px; z-index: 10000; display: none;
    }
</style>
</head>
<body>

<div id="updateBanner" class="update-banner" onclick="applyUpdate()">
    üöÄ ÁôºÁèæÊñ∞ÁâàÊú¨ÔºÅÈªûÊìäÊ≠§ËôïÁ´ãÂç≥Êõ¥Êñ∞‰ªãÈù¢
</div>

<div id="toast" class="toast">Â∑≤Ë§áË£Ω</div>

<div class="header-section">
    <div style="display: flex; align-items: center; gap: 10px;">
        <h1 onclick="toggleTheme()">Whatsup</h1>
        <div style="font-size: 12px; color: var(--primary); font-weight: 600;">PRO</div>
    </div>
    <div class="theme-toggle" onclick="toggleTheme()" id="themeIcon">üåì</div>
</div>

<div class="feed-container" id="feed"></div>

<div class="wa-footer">
    <div class="input-wrapper" id="dropZone">
        <div id="previewContainer"></div>
        <div class="wa-input-row">
            <label for="photo" class="icon-btn" style="font-weight: 300;">+</label>
            <input type="file" id="photo" style="display:none" multiple>
            <textarea id="msg" rows="1" placeholder="Ëº∏ÂÖ•Ë®äÊÅØ„ÄÅ‰ª£Á¢ºÊàñÊãñÊîæÊ™îÊ°à..." oninput="autoResize(this)"></textarea>
            <button id="uploadBtn" class="icon-btn send-btn">‚û§</button>
        </div>
        <div id="progressBox"><div id="progressBar"></div></div>
        <div id="qualitySelector">
            <span id="modeCompress" class="q-chip active" onclick="setMode('compress')">Â£ìÁ∏Æ</span>
            <span id="modeRaw" class="q-chip" onclick="setMode('raw')">ÂéüÂúñ</span>
        </div>
    </div>
</div>

<script>
    const APP_VERSION = '3.1'; 
    const SB_URL = 'https://tywvhvarouhzapqihcit.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR5d3ZodmFyb3VoemFwcWloY2l0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5ODI2OTMsImV4cCI6MjA4MjU1ODY5M30.3LLxsdfXHZ3EkpNpwI5AzKHCSx1499Ha7tXzS6mkTvI';
    const db = supabase.createClient(SB_URL, SB_KEY);

    function initTheme() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.setAttribute('data-theme', 'dark');
        }
    }
    function toggleTheme() {
        const target = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', target);
        localStorage.setItem('theme', target);
    }
    initTheme();

    let uploadMode = 'compress';
    let selectedFiles = [];

    const msgInput = document.getElementById('msg');
    const photoInput = document.getElementById('photo');
    const feed = document.getElementById('feed');
    const uploadBtn = document.getElementById('uploadBtn');
    const previewContainer = document.getElementById('previewContainer');
    const dropZone = document.getElementById('dropZone');
    const progressBox = document.getElementById('progressBox');
    const progressBar = document.getElementById('progressBar');

    const SPINNER_HTML = `<svg class="spinner" viewBox="0 0 50 50"><circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle></svg>`;

    function autoResize(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
    }

    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        const files = Array.from(e.dataTransfer.files);
        if (files.length > 0) { selectedFiles = [...selectedFiles, ...files]; renderPreviews(); }
    });

    msgInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); }
    });

    function escapeHTML(str) {
        return str ? str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m])) : '';
    }

    function getFileNameFromUrl(url) {
        try {
            const decodedUrl = decodeURIComponent(url);
            const fullFileName = decodedUrl.split('/').pop();
            return fullFileName.includes('_') ? fullFileName.split('_').slice(1).join('_') : fullFileName;
        } catch(e) { return "Êú™Áü•Ê™îÊ°à"; }
    }

    // --- Êñ∞Â¢ûÔºöÂº∑Âà∂‰∏ãËºâÂáΩÊï∏ ---
    async function downloadFile(url, filename) {
        try {
            const res = await fetch(url);
            const blob = await res.blob();
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename || getFileNameFromUrl(url);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
        } catch (e) {
            window.open(url, '_blank'); // Â¶ÇÊûú fetch Â§±ÊïóÔºà‰æãÂ¶ÇË∑®ÂüüÂïèÈ°åÔºâÔºåÂâáÁõ¥Êé•ÊâìÈñã
        }
    }

    function render(data) {
        if (!data) return;
        feed.innerHTML = data.map(p => {
            const time = new Date(p.created_at).toLocaleString([], {hour:'2-digit', minute:'2-digit'});
            const isCode = p.message && (p.message.includes('=>') || p.message.includes('{') || p.message.includes('const '));
            const safeBase64 = window.btoa(unescape(encodeURIComponent(p.message || "")));
            
            let urls = [];
            if (p.url) { try { urls = JSON.parse(p.url); } catch(e) { urls = p.url.split(','); } }
            if (!Array.isArray(urls)) urls = [urls];

            const imgs = urls.filter(u => u.match(/\.(jpg|jpeg|png|gif|webp)/i));
            const files = urls.filter(u => !u.match(/\.(jpg|jpeg|png|gif|webp)/i));

            let attachmentHTML = '';
            if (imgs.length > 0) {
                attachmentHTML += `<div class="attachment-grid">${imgs.map(u => `
                    <div style="position:relative">
                        <img src="${u}" class="post-img" onclick="window.open('${u}')">
                        <span class="dl-icon" style="position:absolute; bottom:5px; right:5px; background:white; box-shadow:0 2px 5px rgba(0,0,0,0.2)" onclick="downloadFile('${u}')">üì•</span>
                    </div>
                `).join('')}</div>`;
            }
            if (files.length > 0) {
                attachmentHTML += files.map(u => {
                    const fname = getFileNameFromUrl(u);
                    return `
                    <div class="file-attachment">
                        <span onclick="window.open('${u}')" style="cursor:pointer">üìÑ</span>
                        <span style="flex:1; cursor:pointer" onclick="window.open('${u}')">${escapeHTML(fname)}</span>
                        <span class="dl-icon" onclick="downloadFile('${u}', '${fname}')" title="‰∏ãËºâ">üì•</span>
                    </div>
                `}).join('');
            }

            return `
                <div class="item-row">
                    <div class="item-header">
                        <span>${time}</span>
                        <div class="action-row">
                            <span class="copy-btn" onclick="copySafe('${safeBase64}')">Ë§áË£Ω</span>
                            <span class="del-btn" onclick="deletePost(${p.id})">Âà™Èô§</span>
                        </div>
                    </div>
                    <div class="content-wrapper" id="wrapper-${p.id}">
                        ${isCode ? `<div class="code-block">${escapeHTML(p.message)}</div>` : `<div style="white-space:pre-wrap;">${escapeHTML(p.message)}</div>`}
                    </div>
                    <div class="expand-hint" id="hint-${p.id}" onclick="toggleExpandById(${p.id})">ÈªûÊìäÂ±ïÈñã</div>
                    ${attachmentHTML}
                </div>
            `;
        }).join('');
        checkOverflow();
        feed.scrollTop = feed.scrollHeight;
    }

    function uploadWithProgress(file, path) {
        return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            const url = `${SB_URL}/storage/v1/object/uploads/${path}`;
            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percent = (e.loaded / e.total) * 100;
                    progressBar.style.width = percent + '%';
                }
            });
            xhr.addEventListener('load', () => {
                if (xhr.status >= 200 && xhr.status < 300) resolve();
                else reject(new Error('Upload failed'));
            });
            xhr.addEventListener('error', () => reject(new Error('Network error')));
            xhr.open('POST', url);
            xhr.setRequestHeader('Authorization', `Bearer ${SB_KEY}`);
            xhr.setRequestHeader('apikey', SB_KEY);
            xhr.send(file);
        });
    }

    async function handleSend() {
        const message = msgInput.value.trim();
        if (selectedFiles.length === 0 && !message) return;
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = SPINNER_HTML;
        if (selectedFiles.length > 0) progressBox.style.display = 'block';
        try {
            let uploadedUrls = [];
            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                const finalFile = (file.type.startsWith('image/') && uploadMode === 'compress') ? await compressImage(file) : file;
                const path = `${Date.now()}_${file.name}`;
                progressBar.style.width = '0%';
                await uploadWithProgress(finalFile, path);
                uploadedUrls.push(db.storage.from('uploads').getPublicUrl(path).data.publicUrl);
            }
            await db.from('posts').insert([{ message, url: JSON.stringify(uploadedUrls) }]);
            msgInput.value = ''; msgInput.style.height = 'auto';
            clearPhoto();
            fetchPosts();
        } catch (e) { alert('Â§±Êïó: ' + e.message); } finally {
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = "‚û§";
            progressBox.style.display = 'none';
        }
    }

    uploadBtn.onclick = handleSend;

    photoInput.onchange = () => {
        const files = Array.from(photoInput.files);
        if (files.length > 0) { selectedFiles = [...selectedFiles, ...files]; renderPreviews(); }
        photoInput.value = '';
    };

    function renderPreviews() {
        previewContainer.innerHTML = '';
        if (selectedFiles.length === 0) {
            previewContainer.style.display = 'none';
            document.getElementById('qualitySelector').style.display = 'none';
            return;
        }
        previewContainer.style.display = 'flex';
        document.getElementById('qualitySelector').style.display = 'flex';
        selectedFiles.forEach((file, index) => {
            const div = document.createElement('div');
            div.className = 'preview-item';
            div.innerHTML = `<button class="remove-preview" onclick="removeFile(${index})">‚úï</button>`;
            const img = document.createElement('img');
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => img.src = e.target.result;
                reader.readAsDataURL(file);
            } else { img.src = 'https://cdn-icons-png.flaticon.com/512/2991/2991108.png'; }
            div.appendChild(img);
            previewContainer.appendChild(div);
        });
    }

    function removeFile(index) { selectedFiles.splice(index, 1); renderPreviews(); }
    function clearPhoto() { selectedFiles = []; renderPreviews(); }
    function setMode(mode) {
        uploadMode = mode;
        document.getElementById('modeCompress').classList.toggle('active', mode === 'compress');
        document.getElementById('modeRaw').classList.toggle('active', mode === 'raw');
    }
    async function compressImage(file) {
        return new Promise((resolve) => {
            const img = new Image();
            img.src = URL.createObjectURL(file);
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX = 1200;
                let w = img.width, h = img.height;
                if (w > MAX) { h *= MAX/w; w = MAX; }
                canvas.width = w; canvas.height = h;
                canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                canvas.toBlob(b => resolve(b), 'image/jpeg', 0.8);
            };
        });
    }
    function showToast(text = "Â∑≤Ë§áË£Ω") {
        const t = document.getElementById('toast');
        t.innerText = text; t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 1500);
    }
    function copySafe(base64Str) {
        const text = decodeURIComponent(escape(window.atob(base64Str)));
        navigator.clipboard.writeText(text).then(() => showToast());
    }
    function checkOverflow() {
        document.querySelectorAll('.content-wrapper').forEach(wrapper => {
            const hint = wrapper.parentElement.querySelector('.expand-hint');
            if (wrapper.scrollHeight > 205) {
                wrapper.classList.add('has-overflow');
                if (hint) hint.style.display = 'block';
            } else {
                wrapper.style.maxHeight = 'none';
                wrapper.classList.remove('has-overflow');
                if (hint) hint.style.display = 'none';
            }
        });
    }
    function toggleExpandById(id) {
        const w = document.getElementById(`wrapper-${id}`), h = document.getElementById(`hint-${id}`);
        w.classList.toggle('expanded');
        h.innerText = w.classList.contains('expanded') ? "ÈªûÊìäÊî∂Ëµ∑" : "ÈªûÊìäÂ±ïÈñã";
    }
    async function fetchPosts() {
        const { data } = await db.from('posts').select('*').order('created_at', { ascending: true });
        render(data);
    }
    async function deletePost(id) { await db.from('posts').delete().eq('id', id); fetchPosts(); }
    function applyUpdate() { location.reload(true); }

    db.channel('posts').on('postgres_changes', { event: '*', schema: 'public', table: 'posts' }, fetchPosts).subscribe();
    fetchPosts();
</script>

</body>
</html>
